# **Phương thức Join và Token (Join Methods and Tokens)**

## **I. Giới thiệu**

Phần này trình bày các khái niệm cốt lõi của quá trình *tham gia cụm Teleport* (Teleport joining process), liệt kê toàn bộ các phương thức tham gia (join methods) được hỗ trợ, và phân loại chúng dựa trên đặc tính bảo mật.
### **Định nghĩa**

#### **1. Joining (Tham gia cụm)**

Tham gia cụm Teleport là quá trình **thiết lập niềm tin (trust)** giữa một thực thể Teleport mới và toàn bộ các thực thể đã có trong cụm.
Khi quá trình này hoàn tất, **Dịch vụ Xác thực (Auth Service)** sẽ ký phát chứng chỉ (certificate) cho thực thể mới, đại diện cho sự tin cậy đã được xác lập. Nhờ các chứng chỉ này, thực thể mới có thể tương tác an toàn với các thực thể khác trong cụm.

Để yêu cầu cấp chứng chỉ, thực thể mới phải **chứng minh danh tính của mình** với Auth Service. Teleport hỗ trợ nhiều cách khác nhau để xác thực danh tính, được gọi là **join methods**.

Quá trình *joining* chỉ diễn ra khi thực thể Teleport chưa có chứng chỉ hợp lệ. Sau khi mã thông báo (token) được trao đổi lấy chứng chỉ, các chứng chỉ đó sẽ được dùng cho các lần kết nối tiếp theo — thường diễn ra trong lần khởi động đầu tiên.


### **2. Join Method (Phương thức tham gia)**

Phương thức tham gia là cách Auth Service xác thực rằng một thực thể yêu cầu gia nhập cụm Teleport là hợp lệ.
Một số phương thức có thể áp dụng chung cho mọi môi trường, trong khi các phương thức khác phụ thuộc vào **ngữ cảnh của thực thể tham gia** — ví dụ:

* Các phương thức dựa trên nhà cung cấp đám mây như `iam`, `gcp`, `azure`
* Các phương thức dựa trên nền tảng CI/CD như `github`, `gitlab`, `circleci`

Các phương thức này có thể cung cấp mức độ bảo mật cao hơn, nhưng yêu cầu thực thể phải hoạt động trong môi trường tương ứng.

Mỗi join method mang lại **mức độ bảo mật khác nhau**.
Ví dụ:

* Một số cho phép cấp **chứng chỉ có thể gia hạn** (renewable certificates).
* Một số khác yêu cầu **thực hiện tham gia lại** khi chứng chỉ hết hạn.

Phương thức và các tham số của nó được định nghĩa trong **tài nguyên token**.


### **3. Token (Mã thông báo)**

Token là một tài nguyên trong Teleport, xác định **phương thức tham gia nào** được phép sử dụng và **trong ngữ cảnh nào**.

Ví dụ, một token cho phép dịch vụ SSH tham gia bằng phương thức `iam` nếu chúng thuộc tài khoản AWS cụ thể và có quyền assume role tương ứng:

```yaml
kind: token
version: v2
metadata:
  name: my-iam-token
spec:
  roles: [Node]
  join_method: iam
  allow:
  - aws_account: "333333333333"
    aws_arn: "arn:aws:sts::333333333333:assumed-role/teleport-instance-role/i-*"
```

> ⚠️ **Lưu ý quan trọng:**
> Tên của token có thể là **thông tin nhạy cảm** tùy theo phương thức tham gia.
> Với các phương thức dựa trên bí mật (secret-based), **tên token chính là bí mật** cần được bảo vệ tuyệt đối. Chỉ cần biết tên token cũng đủ để tham gia cụm.


# **II. Phân loại phương thức tham gia**

## **1. Theo loại xác thực: Bí mật (Secret) vs Ủy quyền (Delegated)**

**a. Secret-based Join Methods (Dựa trên bí mật)**

* Áp dụng cho mọi nền tảng.
* Thực thể gửi một *bí mật* (secret token) để Auth Service xác minh.
* Nhược điểm: dễ bị rò rỉ hoặc đánh cắp bí mật.
* Khuyến nghị: sử dụng **token ngắn hạn** (ví dụ: chỉ hiệu lực 1 giờ) để giảm thiểu rủi ro.

**Các phương thức thuộc nhóm này:**

* `ephemeral token`
* `static token`

> ⚠️ Teleport chỉ hỗ trợ **static token** để đảm bảo khả năng tương thích ngược. Không khuyến khích sử dụng.



**b. Delegated Join Methods (Dựa trên ủy quyền/ngữ cảnh)**

* Dựa vào **ngữ cảnh và bên thứ ba** (cloud provider, CI/CD, container runtime) để xác lập niềm tin.
* Không phải lúc nào cũng áp dụng được (ví dụ: thiết bị IoT nhỏ không thể dùng IAM), nhưng **nên ưu tiên sử dụng khi có thể**.
* Cung cấp **mức kiểm soát chi tiết hơn**, chẳng hạn cho phép tham gia dựa trên:

  * Vùng khả dụng (Availability Zone)
  * Tài khoản đám mây (Cloud Account ID)
  * Dịch vụ hoặc vai trò cụ thể

**Các phương thức thuộc nhóm này:**

```
azure, azure_devops, bitbucket, bound_keypair, circleci,
ec2, gcp, github, gitlab, iam, kubernetes,
oracle, spacelift, terraform_cloud, tpm
```


## **2. Theo khả năng gia hạn chứng chỉ: Renewable vs Non-Renewable**

**a. Renewable Join Methods (Có thể gia hạn)**

* Cho phép thực thể tự yêu cầu chứng chỉ mới mà không cần token lại.
* Thường áp dụng với các phương thức dựa trên bí mật (secret-based) hoặc có session ngắn hạn.

**Các phương thức:**

```
ephemeral token, static token, ec2, bound_keypair
```

**b. Non-Renewable Join Methods (Không thể gia hạn)**

* Khi chứng chỉ hết hạn, thực thể phải thực hiện tham gia lại để chứng minh tính hợp lệ.
* Bảo mật cao hơn, phù hợp cho các workload tạm thời như CI/CD hoặc container.

**Các phương thức:**

```
iam, azure, azure_devops, gcp, github,
circleci, gitlab, kubernetes, tpm
```

---

## **III. Cấu trúc tài nguyên Token**

Ví dụ định nghĩa tài nguyên token chuẩn:

```yaml
# token.yaml
kind: token
version: v2
metadata:
  name: my-token-name
spec:
  roles:
    - Node
    - App
  join_method: gcp
  bot_name: my-bot

  suggested_labels:
    teams: ["sales-eng", "eng", "qa"]
    application: ["demo-product"]

  suggested_agent_matcher_labels:
    teams: ["sales-eng"]
```

#### **Giải thích thành phần:**

* **roles:**
  Mô tả các vai trò hệ thống mà thực thể Teleport có thể đảm nhiệm.
  Một số vai trò phổ biến:

  * `Node` – Dịch vụ SSH
  * `Proxy` – Dịch vụ Proxy
  * `Kube` – Dịch vụ Kubernetes
  * `App` – Dịch vụ Ứng dụng
  * `Db` – Dịch vụ Cơ sở dữ liệu
  * `WindowsDesktop` – Dịch vụ Môi trường Desktop Windows
  * `Discovery` – Dịch vụ Khám phá
  * `Bot` – Dịch vụ MachineID

* **bot_name:**
  Chỉ định khi token được dùng cho `MachineID`.

* **suggested_labels / suggested_agent_matcher_labels:**
  Gợi ý các nhãn (labels) cho việc cấu hình tài nguyên hoặc agent phát hiện tài nguyên.


### **Kết luận**

Việc lựa chọn **join method phù hợp** ảnh hưởng trực tiếp đến:

* **Mức độ bảo mật** của cụm Teleport,
* **Khả năng tự động hóa và tái sử dụng**,
* Và **quy trình quản lý vòng đời chứng chỉ**.

Khuyến nghị:

* **Ưu tiên phương thức delegated** khi có thể.
* Chỉ sử dụng **secret-based tokens** cho môi trường tạm thời hoặc khi không có lựa chọn khác.
* **Thiết lập thời hạn ngắn** cho token bí mật để giảm rủi ro bảo mật.


## **IV. Các phương thức tham gia (Join Methods)**

### **1. Static Tokens (Mã thông báo tĩnh)**

> ⚠️ **Cảnh báo bảo mật:**
> Phương thức này **kém an toàn** do mã thông báo tĩnh tồn tại lâu dài, có thể bị đánh cắp và tái sử dụng.
> Việc sử dụng static token **làm suy giảm đáng kể** lợi ích bảo mật của Teleport.
> **Không khuyến nghị sử dụng**, thay vào đó nên dùng **ephemeral token (mã thông báo tạm thời)**.

**Định nghĩa:**
Static token là các mã thông báo được định nghĩa cố định trong cấu hình của **Auth Service** (tệp `teleport.yaml`).
Tên token phải được **giữ bí mật tuyệt đối**, vì chỉ cần biết tên token là có thể tham gia vào cụm Teleport.

**Ví dụ cấu hình:**

```yaml
auth_service:
  enabled: true
  # Các mã thông báo định nghĩa trước dùng để thêm thực thể mới vào cụm.
  # Mỗi token quy định vai trò mà thực thể mới được phép đảm nhiệm.
  # Phương thức an toàn hơn là sử dụng lệnh `tctl nodes add --ttl` để sinh token tự động hết hạn.
  # Công cụ `pwgen`
  # Tối thiểu 32 byte.
  tokens:
    - "proxy,node:xxxxx"
    - "auth:yyyy"
    - "discovery,app,db:zzzzz"
```

### **2. Ephemeral Tokens (Mã thông báo tạm thời)**

Ephemeral token là **mã bí mật được tạo động** thông qua CLI hoặc API của Teleport, chỉ có hiệu lực trong thời gian ngắn (thường vài phút).
Các token này thường được tạo ngay trước khi thực thể tham gia vào cụm Teleport.

**Tạo bằng CLI:**

```bash
tctl tokens add --type discovery,app --ttl 15m
```

> Nếu không chỉ định giá trị cụ thể, hệ thống sẽ tự tạo chuỗi ngẫu nhiên mạnh và mặc định TTL là 30 phút.

**Tạo dưới dạng tài nguyên Teleport:**

```yaml
kind: token
version: v2
metadata:
  expires: "2023-11-24T21:45:40.104524Z"
  name: abcd123-insecure-do-not-use-this
spec:
  join_method: token
  roles:
    - Discovery
    - App
```

Khi **bot Machine ID** sử dụng ephemeral token để tham gia, token sẽ **tự động bị xóa** sau khi hoàn tất.

> **Khuyến nghị nâng cấp:**
> Đối với các triển khai mới của Machine ID hoặc Workload Identity Bot, nên **chuyển sang phương thức `bound_keypair`** để tăng cường bảo mật và khả năng phục hồi.

### **3. Bound Keypair (Cặp khóa ràng buộc)**

Phương thức **bound_keypair** là giải pháp thay thế cho các join method dựa trên bí mật, dành riêng cho **Machine ID Bot và Workload Identity Bot**, giúp **tăng cường bảo mật và linh hoạt hơn**.

Phương thức này hoạt động tốt nhất trên các **nền tảng có lưu trữ bền vững (persistent storage)**, nhưng vẫn có thể cấu hình cho hầu hết các môi trường khác.

>  **Khuyến nghị sử dụng:**
> Phù hợp cho các môi trường **on-premises không có TPM** hoặc **nền tảng đám mây không hỗ trợ join method ủy quyền chuyên biệt**.
>
>  **Giới hạn:**
> Hiện tại, `bound_keypair` **chỉ dùng được** cho Machine ID và Workload ID Bot, **không áp dụng** cho các loại agent Teleport khác.

**Ví dụ cấu hình:**

```yaml
kind: token
version: v2
metadata:
  name: example-token
spec:
  roles: [Bot]
  join_method: bound_keypair
  bot_name: example

  bound_keypair:
    onboarding:
      initial_public_key: ""
      registration_secret: ""
      must_register_before: ""

    recovery:
      limit: 1
      mode: "standard"

    rotate_after: ""
```

**Giải thích các trường chính:**

* **onboarding:** Giai đoạn đăng ký ban đầu.

  * `initial_public_key`: Khóa công khai ở định dạng SSH authorized_keys; client phải có khóa riêng tương ứng.
  * `registration_secret`: Chuỗi bí mật cho phép client thực hiện lần tham gia đầu tiên nếu chưa có khóa công khai.
  * `must_register_before`: Thời hạn tối đa cho phép đăng ký.

* **recovery:** Giai đoạn phục hồi sau khi chứng chỉ hết hạn.

  * `limit`: Số lần phục hồi tối đa được phép.
  * `mode`: Chế độ phục hồi (`standard`, `relaxed`, `insecure`), tùy theo mức độ kiểm soát bảo mật.

* **rotate_after:** Thời điểm buộc phải xoay vòng cặp khóa (keypair rotation).


### **4. AWS IAM Role (`iam`)**

Phương thức **IAM join** được sử dụng cho mọi tiến trình Teleport có quyền truy cập **AWS IAM credentials**, ví dụ như **EC2 instance có gán IAM role**.
Không yêu cầu quyền hay chính sách IAM đặc biệt — chỉ cần một IAM role trống là đủ.
Auth Service **không cần có IAM credentials**.

> **Khuyến nghị sử dụng:**
> Đây là phương thức tham gia **được đề xuất** cho các workload chạy trên AWS.

**Ví dụ:**

```yaml
kind: token
version: v2
metadata:
  name: iam-token
spec:
  roles: [Node]
  join_method: iam
  allow:
    - aws_account: "111111111111"
    - aws_account: "222222222222"
    - aws_account: "333333333333"
      aws_arn: "arn:aws:sts::333333333333:assumed-role/teleport-node-role/i-*"
```

> Tên token **không phải là bí mật**, vì thực thể phải chứng minh rằng chúng đang chạy trong tài khoản AWS hợp lệ để có thể sử dụng token này.

**Xem thêm:**

* *Joining Services via AWS IAM Role*
* *Deploying Machine ID on AWS*


### **5. AWS EC2 Identity Document (`ec2`)**

Phương thức **EC2 join** được dùng cho các tiến trình Teleport chạy **trên EC2 instance**.
Mỗi EC2 instance chỉ được phép có **một tiến trình Teleport** sử dụng phương thức này.

Auth Service cần có **IAM quyền `ec2:DescribeInstances`**, trong khi tiến trình Teleport tham gia cụm **không cần IAM credentials**.

> **Lưu ý:**
> Phương thức EC2 **không khả dụng** trong **Teleport Enterprise Cloud** và **Teleport Team**.
> Người dùng các gói đó nên dùng `iam` hoặc `ephemeral token`.

**Ví dụ:**

```yaml
kind: token
version: v2
metadata:
  name: ec2-token
spec:
  roles: [Node]
  join_method: ec2
  aws_iid_ttl: 5m
  allow:
    - aws_account: "111111111111"
      aws_regions:
        - us-west-1
        - us-west-2
```

* `aws_iid_ttl`: Thời gian cho phép sau khi instance khởi chạy để tham gia cụm.
  Nên giữ TTL ngắn để giảm rủi ro lạm dụng tài liệu nhận dạng EC2 bị đánh cắp.

### **6. Azure Managed Identity (`azure`)**
Phương thức **Azure join** cho phép các tiến trình Teleport chạy trên **Azure Virtual Machine** tham gia cụm.
Từ phiên bản **Teleport 13.0+**, phương thức này hỗ trợ **Proxy Service** phía sau **Load Balancer tầng 7 hoặc Reverse Proxy**.

**Ví dụ:**

```yaml
kind: token
version: v2
metadata:
  name: azure-token
spec:
  roles: [Node]
  join_method: azure
  azure:
    allow:
      - subscription: 11111111-1111-1111-1111-111111111111
      - subscription: 22222222-2222-2222-2222-222222222222
      - subscription: 33333333-3333-3333-3333-333333333333
        resource_groups: ["group1", "group2"]
```

> Tên token **không phải bí mật**, vì thực thể cần chứng minh rằng nó đang chạy trong subscription Azure hợp lệ.


### **7. Azure DevOps (`azure_devops`)**

Phương thức **Azure DevOps join** được thiết kế cho các tiến trình Teleport chạy trong **Azure DevOps pipeline**, đặc biệt là khi cần **Machine ID** hoặc **Workload Identity** để truy cập tài nguyên Teleport mà **không cần bí mật lâu dài**.

**Ví dụ:**

```yaml
kind: token
version: v2
metadata:
  name: azure-devops-token
spec:
  roles: [Bot]
  join_method: azure_devops
  bot_name: my-bot
  azure_devops:
    organization_id: 11111111-1111-1111-1111-111111111111
    allow:
      - sub: p://my-organization/my-project/my-pipeline
        project_name: my-project
        pipeline_name: my-pipeline
        project_id: 22222222-2222-2222-2222-222222222222
        definition_id: 1
        repository_uri: https://github.com/gravitational/teleport.git
        repository_version: e6b9eb29a288b27a3a82cc19c48b9d94b80aff36
        repository_ref: refs/heads/main
```
### **8. GCP Service Account (`gcp`)**

Phương thức **GCP join** được sử dụng cho mọi tiến trình Teleport chạy trên **máy ảo GCP (Google Cloud Platform VM)**.
Máy ảo này cần được gán **service account** (có thể sử dụng **service account mặc định**).
Quá trình Teleport tham gia cụm **không yêu cầu bất kỳ vai trò IAM nào**.

#### **Ví dụ cấu hình: `token.yaml`**

```yaml
kind: token
version: v2
metadata:
  # Tên token không phải là bí mật, vì các máy ảo phải chứng minh
  # rằng chúng đang chạy trong dự án GCP hợp lệ để sử dụng token này.
  name: gcp-token
spec:
  # Xác định tập vai trò tối thiểu cần thiết (ví dụ: Node, Proxy, App, Kube, DB, WindowsDesktop)
  roles: [Node]

  # Chỉ định phương thức tham gia cho token này
  join_method: gcp
  gcp:
    allow:
      # Các ID của dự án GCP mà VM được phép tham gia.
      - project_ids: ["example-project-id"]

        # (Tùy chọn) Các vị trí (region hoặc zone) mà VM được phép tham gia.
        locations: ["us-west1", "us-west2-a"]

        # (Tùy chọn) Địa chỉ email của các service account được phép tham gia.
        service_accounts: ["example@example.com"]
```

### **9. GitHub Actions (`github`)**

Teleport hỗ trợ phương thức **tham gia an toàn** cho cả:

* **GitHub Actions** (bao gồm runner do GitHub hoặc người dùng tự lưu trữ), và
* **GitHub Enterprise Server (GHES)**.

Phương thức này thường được sử dụng cùng **Machine ID** để cấp quyền truy cập vào các tài nguyên được bảo vệ bởi Teleport trong **pipeline của GitHub Actions**.

#### **Ví dụ cấu hình:**

```yaml
kind: token
version: v2
metadata:
  # Tên token dùng để nhận dạng, được chỉ định khi cấu hình bot hoặc node.
  name: github-token
spec:
  # Với Machine ID và GitHub, vai trò luôn là "Bot" và join_method luôn là "github".
  roles: [Bot]
  join_method: github

  # Tên bot mà token này cấp quyền truy cập khi sử dụng.
  bot_name: github-demo

  github:
    # Tùy chọn cho GitHub Enterprise Server (GHES).
    # Nếu sử dụng github.com, không cần khai báo.
    enterprise_server_host: ghes.example.com

    # (Tùy chọn) Cấu hình JWKS tĩnh, dùng để xác minh token do GHES phát hành
    # trong trường hợp Auth Service không thể truy cập GHES.
    static_jwks: |
      {"keys":[--snip--]}

    # (Tùy chọn) Cấu hình enterprise_slug để tương thích với GHES.
    # Chỉ định slug của tổ chức GitHub Enterprise khi cần.
    enterprise_slug: slug

    # Quy tắc cho phép (allow) xác định các workflow nào được phép tham gia.
    allow:
      - repository: gravitational/teleport
        repository_owner: gravitational
        workflow: my-workflow
        environment: production
        actor: octocat
        ref: ref/heads/main
        ref_type: branch
        sub: repo:gravitational/example-repo:environment:production
```


**Hỗ trợ GitHub Actions có sẵn:**

* [teleport-actions/setup](https://github.com/teleport-actions/setup)
* [teleport-actions/auth](https://github.com/teleport-actions/auth)
* [teleport-actions/auth-k8s](https://github.com/teleport-actions/auth-k8s)
* [teleport-actions/auth-application](https://github.com/teleport-actions/auth-application)

---

### **10. CircleCI (`circleci`)**

Phương thức **CircleCI join** thường được sử dụng cùng **Machine ID** để cấp quyền truy cập vào tài nguyên Teleport trong các **pipeline CircleCI**.

#### **Ví dụ cấu hình:**

```yaml
kind: token
version: v2
metadata:
  name: example-bot
spec:
  roles: [Bot]
  join_method: circleci
  bot_name: example
  circleci:
    organization_id: $ORGANIZATION_ID
    allow:
      - context_id: 00000000-0000-0000-0000-000000000000
        project_id: 1234
```

### **11. GitLab (`gitlab`)**

Teleport hỗ trợ tham gia an toàn cho cả **GitLab cloud-hosted** và **GitLab tự lưu trữ** (self-hosted).
Phiên bản GitLab **tối thiểu được hỗ trợ là 15.7**.
Phương thức này thường được dùng cùng **Machine ID** để truy cập tài nguyên Teleport trong **pipeline GitLab CI**.

#### **Ví dụ cấu hình:**

```yaml
kind: token
version: v2
metadata:
  name: gitlab-demo
spec:
  roles: [Bot]
  join_method: gitlab
  bot_name: gitlab-demo

  gitlab:
    # (Tùy chọn) Tên miền GitLab instance (bỏ trống nếu sử dụng gitlab.com)
    domain: gitlab.example.com

    # (Tùy chọn) JWKS tĩnh — sử dụng khi Auth Service không thể truy cập GitLab.
    static_jwks: |
      {"keys":[--snip--]}

    allow:
      - project_path: my-user/my-project
        namespace_path: my-user
        pipeline_source: web
        environment: production
        ref_type: branch
        ref: main
        sub: project_path:my-user/my-project:ref_type:branch:ref:main
        user_login: octocat
        user_email: octo.cat@example.com
        ref_protected: true
        environment_protected: true
        ci_config_sha: ffffffffffffffffffffffffffffffffffffffff
        ci_config_ref_uri: gitlab.example.com/my-group/my-project//.gitlab-ci.yml@refs/heads/main
        deployment_tier: production
        project_visibility: public
```

### **12.  Kubernetes (`kubernetes`)**

Phương thức tham gia Kubernetes có **ba biến thể chính**:

1. **In-cluster**
2. **JWKS**
3. **OIDC**

---

#### **12.1. Kubernetes In-cluster**

Phương thức **in-cluster** được sử dụng cho các tiến trình Teleport chạy **trong cùng cụm Kubernetes** với **Auth Service**.
Cơ chế này dựa vào **ServiceAccount token** của Kubernetes để xác thực danh tính Pod thông qua **API TokenReview**.
Do API này chỉ khả dụng bên trong cụm, phương thức này **chỉ áp dụng cho Teleport tự triển khai trong Kubernetes (self-hosted)**.

Ưu điểm quan trọng:

> Token sẽ **bị thu hồi ngay khi Pod chuyển sang trạng thái Terminated**, giúp đảm bảo bảo mật tức thời.

#### **Ví dụ cấu hình**

```yaml
kind: token
version: v2
metadata:
  # Tên token không phải là bí mật vì việc xác thực dựa trên chữ ký Kubernetes.
  name: kubernetes-token
  # Thiết lập thời hạn hiệu lực dài hơn (token mặc định chỉ có 30 phút).
  expires: "2050-01-01T00:00:00Z"
spec:
  roles: [App]
  join_method: kubernetes
  kubernetes:
    # Mặc định là in_cluster nếu không chỉ định.
    type: in_cluster
    allow:
      # Định dạng: "namespace:tên_service_account".
      - service_account: "teleport-agent:teleport-app-service"
```

#### **12.2. Kubernetes JWKS**

Phương thức **Kubernetes JWKS** cho phép bất kỳ tiến trình Teleport nào đang chạy trong Kubernetes tham gia cụm Teleport.
Khác với phương thức trước, **Auth Service không cần chạy trong Kubernetes**, do đó có thể sử dụng với **Teleport Cloud** hoặc các cụm ngoài.

Cơ chế hoạt động:

* Các **khóa công khai ký Kubernetes (JWKS)** được xuất ra ngoài.
* **Auth Service** dùng các khóa này để xác thực chữ ký của ServiceAccount token mà không cần kết nối trực tiếp tới API Kubernetes.

#### **Ví dụ cấu hình**

```yaml
kind: token
version: v2
metadata:
  name: example
spec:
  roles: [App]
  join_method: kubernetes
  kubernetes:
    type: static_jwks
    static_jwks:
      jwks: |
        # Lấy JWKS bằng lệnh:
        # kubectl get --raw /openid/v1/jwks
        {"keys":[--snip--]}
    allow:
      - service_account: "namespace:serviceaccount"
```

⚠️ **Lưu ý quan trọng:**
Khi **xoay vòng CA Kubernetes (CA rotation)**, bạn **phải cập nhật** phần `spec.kubernetes.static_jwks.jwks` trong token để chứa bộ khóa mới.

**Tham khảo:**

* *Deploying Machine ID on Kubernetes*

---

#### **12.3. Kubernetes OIDC**

Phương thức **Kubernetes OIDC** cho phép tiến trình Teleport tham gia cụm trong các môi trường mà **ServiceAccount token** được phát hành bởi một **nhà cung cấp OIDC công khai** (OIDC-compliant issuer).

Cơ chế này sử dụng tính năng **Kubernetes Service Account Issuer Discovery** (có từ Kubernetes **v1.21**) để xác minh danh tính workload.
Một số nền tảng như **Amazon EKS** có thể cần cấu hình bổ sung để bật tính năng này.

Khác với biến thể `static_jwks`, phương thức OIDC **tự động truy xuất JWKS từ nhà cung cấp OIDC**, không cần cập nhật thủ công khi khóa thay đổi — một lợi thế đáng kể đối với các nền tảng có xoay vòng khóa định kỳ như EKS.

#### **Yêu cầu:**

* Teleport **phiên bản ≥ 18.1.5**.

#### **Ví dụ cấu hình**

```yaml
kind: token
version: v2
metadata:
  name: example
spec:
  roles: [App]
  join_method: kubernetes
  kubernetes:
    type: oidc
    oidc:
      issuer: https://oidc.eks.us-west-2.amazonaws.com/id/my-cluster
    allow:
      - service_account: "namespace:serviceaccount"
```

### **13.Trusted Platform Module (`tpm`)**

Phương thức **TPM join** là cách xác thực bảo mật cao giữa các Bot hoặc Agent với Auth Service **mà không cần chia sẻ bí mật**.
Thay vì token bí mật, Teleport sử dụng **danh tính duy nhất của phần cứng TPM** cùng **mật mã khóa công khai** để xác thực.

### **Khái niệm cơ bản**

* **TPM (Trusted Platform Module)** là **bộ xử lý mã hóa vật lý** gắn trên máy chủ, có khả năng:

  * Lưu trữ khóa mật mã an toàn.
  * Thực hiện ký số và xác thực mà không để lộ khóa ra ngoài hệ điều hành.
* Mỗi TPM chứa một **cặp khóa gốc (Endorsement Key - EK)** không thể thay đổi.
  Một số TPM còn kèm **chứng chỉ X.509 (EKCert)** do nhà sản xuất ký.

### **Cách hoạt động**

1. Xác định khóa công khai của TPM (`teleport tpm identify`).
2. Tạo token join có chứa giá trị `ek_public_hash` hoặc `ek_certificate_serial`.
3. Teleport sử dụng các giá trị này để xác thực thiết bị trong quá trình tham gia cụm.

> Trong các môi trường không có danh tính máy mặc định (on-premise), đây là **phương thức an toàn nhất**.

⚠️ **Lưu ý:**
Phương thức TPM **chưa tương thích với chuẩn FIPS 140-2**.

#### **Ví dụ cấu hình**

```yaml
kind: token
version: v2
metadata:
  name: tpm-token
spec:
  roles: [Bot]
  join_method: tpm
  bot_name: tpm-demo
  tpm:
    ekcert_allowed_cas:
      - |
        -----BEGIN CERTIFICATE-----
        ... CA Certificate Data ...
        -----END CERTIFICATE-----
    allow:
      - description: "example-build-server-100"
        ek_public_hash: "d4b4example6fabfc568d74f2example6c35a05337d7af9a6example6c891aa6"
        ek_certificate_serial: "01:23:45:67:89:ex:am:pl:e0:23:45:67:89:ab:cd:ef"
```


#### **14. Terraform Cloud (`terraform_cloud`)**

Phương thức **Terraform Cloud join** sử dụng **Workload Identity** của Terraform Cloud hoặc Terraform Enterprise.
Phù hợp cho việc xác thực **Teleport Terraform Provider**, **không hỗ trợ các nền tảng Terraform khác**.

> Yêu cầu **Teleport Enterprise** nếu sử dụng với Terraform Enterprise tự lưu trữ.

#### **Ví dụ cấu hình**

```yaml
kind: token
version: v2
metadata:
  name: terraform
spec:
  roles: [Bot]
  join_method: terraform
  bot_name: terraform
  terraform:
    audience: ''
    hostname: ''
    allow:
      - organization_name: OrgName
        organization_id: org-foo
        project_name: ProjectName
        project_id: prj-bar
        workspace_name: WorkspaceName
        workspace_id: ws-baz
        run_phase: ''
```

#### **15. Spacelift (`spacelift`)**

Phương thức **Spacelift join** cho phép xác thực an toàn giữa Teleport và môi trường **Spacelift**, bao gồm cả bản tự lưu trữ.

#### **Ví dụ cấu hình**

```yaml
kind: token
version: v2
metadata:
  name: spacelift
spec:
  roles: [Bot]
  join_method: spacelift
  bot_name: spacelift
  spacelift:
    hostname: example.app.spacelift.io
    enable_glob_matching: true
    allow:
      - space_id: root
        caller_type: stack
        caller_id: my-stack
        scope: read
```



#### **16. Bitbucket Pipelines (`bitbucket`)**

Phương thức **Bitbucket join** sử dụng cơ chế **OpenID Connect (OIDC)** của Bitbucket để cho phép `tbot` hoặc **Teleport Terraform Provider** xác thực mà không cần token bí mật.

#### **Ví dụ cấu hình**

```yaml
kind: token
version: v2
metadata:
  name: example-bot
spec:
  roles: [Bot]
  join_method: bitbucket
  bot_name: example
  bitbucket:
    identity_provider_url: $IDENTITY_PROVIDER_URL
    audience: $AUDIENCE
    allow:
      - workspace_uuid: '{WORKSPACE_UUID}'
        repository_uuid: '{REPOSITORY_UUID}'
        deployment_environment_uuid: '{DEPLOYMENT_ENVIRONMENT_UUID}'
        branch_name: "main"
```

#### **17. Oracle Cloud (`oracle`)**

Phương thức **Oracle join** được sử dụng cho các tiến trình Teleport chạy trên **Oracle Cloud Compute Instance**.

#### **Ví dụ cấu hình**

```yaml
kind: token
version: v2
metadata:
  name: oracle-token
spec:
  roles: [Node]
  join_method: oracle
  oracle:
    allow:
      - tenancy: "ocid1.tenancy.oc1..<unique ID>"
        parent_compartments: ["ocid1.compartment.oc1...<unique_ID>"]
        regions: ["example-region"]
```

---

### **Tổng kết**

| **STT** | **Phương thức** | **Loại nền tảng** | **Mức bảo mật** | **Tự động thu hồi** | **Phù hợp cho**     |
| :-----: | :-------------- | :---------------- | :-------------: | :-----------------: | :------------------ |
|    1    | Static Token    | Cơ bản            |       Thấp      |          ❌          | Thử nghiệm          |
|    2    | Ephemeral Token | Cơ bản            |    Trung bình   |          ✅          | Sản xuất nhỏ        |
|    3    | Bound Keypair   | Cơ bản            |       Cao       |          ✅          | Hệ thống có PKI     |
|    4    | AWS IAM Role    | Cloud             |       Cao       |          ✅          | AWS EC2/EKS         |
|    5    | Azure Identity  | Cloud             |       Cao       |          ✅          | Azure Cloud         |
|    6    | GCP Identity    | Cloud             |       Cao       |          ✅          | GCP/GKE             |
|    7    | Oracle Identity | Cloud             |    Trung bình   |          ✅          | Oracle Cloud        |
|    8    | K8s In-cluster  | Container         |       Cao       |          ✅          | Teleport nội cụm    |
|    9    | K8s JWKS        | Container         |    Trung bình   |          ❌          | Teleport Cloud      |
|    10   | K8s OIDC        | Container         |       Cao       |          ✅          | EKS/GKE/AKS         |
|    11   | TPM             | Hardware          |     Rất cao     |          ✅          | On-prem             |
|    12   | Terraform Cloud | CI/CD             |       Cao       |          ✅          | IaC pipelines       |
|    13   | Spacelift       | CI/CD             |       Cao       |          ✅          | Terraform CI/CD     |
|    14   | Bitbucket       | CI/CD             |       Cao       |          ✅          | Pipelines Bitbucket |
|    15   | GitHub          | CI/CD             |       Cao       |          ✅          | GitHub Actions      |
|    16   | GitLab          | CI/CD             |       Cao       |          ✅          | GitLab CI/CD        |

---

**Tài liệu này tổng hợp chuẩn hóa toàn bộ các phương thức tham gia Teleport hiện đại, giúp quản trị viên lựa chọn cách xác thực an toàn, tự động và phù hợp nhất cho môi trường triển khai cụ thể.**

